<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
 <script src="jquery-1.10.2.min.js"></script>
 <link href="style.css" rel="stylesheet">
 <style type="text/css">

</style>
<script type="text/javascript">

</script>
</head>
<body>

<div class="themes-p"> 图片设置(注意:支持png,jpg,gif)</div>

<input type="text" size="20" name="upfile" id="upfile" disabled="true">  
<input type="button" value="选择图片" onclick="path.click()" >  
<input type="file" name="path" id="path" style="display:none" accept="image/gif, image/jpeg,image/png"
 onchange="upfile.value=this.value;
	previewImage(this);
  ">

<input id="setdefault" type="button" value="取消" >  
<input id="setbanner" type="text" name="setbanner" value="0" style="display:none;"> 



<div id="preview">
    <img id="imghead" src=''>
</div>
<canvas id="myCanvas">
	Your browser does not support the HTML5 canvas tag.
</canvas>
</body>
</html>
<script type="text/javascript">

var startX, startY, diffX, diffY;
	window.onload=function(e) {
    e = e || window.event;
    // startX, startY 为鼠标点击时初始坐标
    // diffX, diffY 为鼠标初始坐标与 box 左上角坐标之差，用于拖动
    
    // 是否拖动，初始为 false
    var dragging = false;
          
	var existbox = false;	  
	
    // 鼠标按下
    document.onmousedown = function(e) {

		
        startX = e.pageX;
        startY = e.pageY;
		
		if(isimg(startX,startY)!==true){		
			return false;
		}		
		
        // 如果鼠标在 box 上被按下
        if(e.target.className.match(/box/)) {
            // 允许拖动
            dragging = true;
          
            // 设置当前 box 的 id 为 moving_box
            if(document.getElementById("moving_box") !== null) {
                document.getElementById("moving_box").removeAttribute("id");
            }
            e.target.id = "moving_box";
          
            // 计算坐标差值
            diffX = startX - e.target.offsetLeft;
            diffY = startY - e.target.offsetTop;
        }
        else {
			
			if(existbox===true){
				return false;
			}			
            // 在页面创建 box
            var active_box = document.createElement("div");
            active_box.id = "active_box";
            active_box.className = "box";
            active_box.style.top = startY + 'px';
            active_box.style.left = startX + 'px';
            document.body.appendChild(active_box);
            active_box = null;
        }
		e.preventDefault();
    };
           
    // 鼠标移动
    document.onmousemove = function(e) {
        // 更新 box 尺寸
        if(document.getElementById("active_box") !== null) {
            var ab = document.getElementById("active_box");
            ab.style.width = e.pageX - startX + 'px';
            ab.style.height = e.pageY - startY + 'px';
			
			canvasimg(e);
        }
           
        // 移动，更新 box 坐标
        if(document.getElementById("moving_box") !== null && dragging) {
            var mb = document.getElementById("moving_box");
            mb.style.top = e.pageY - diffY + 'px';
            mb.style.left = e.pageX - diffX + 'px';
			
			canvasimg(e);
        }
    };
           
    // 鼠标抬起
    document.onmouseup = function(e) {
        // 禁止拖动
        dragging = false;
        if(document.getElementById("active_box") !== null) {
            var ab = document.getElementById("active_box");
            ab.removeAttribute("id");
			existbox=true;
            // 如果长宽均小于 3px，移除 box
            if(ab.offsetWidth < 3 || ab.offsetHeight < 3) {
                document.body.removeChild(ab);
				existbox=false;
            }
        }
    };
};

function isimg(x,y){
	var img = document.getElementById('imghead');
	if((x>img.offsetLeft)&&(x<(img.offsetLeft+img.offsetWidth))&&(y>img.offsetTop)&&(y<(img.offsetTop+img.offsetHeight))){
		return true;
	}
}




 //本地图片在上传之前的预览效果，老生常谈
 
                //图片上传预览    IE是用了滤镜。
        function previewImage(file)
        {
          var MAXWIDTH  = 260; 
          var MAXHEIGHT = 180;
         // var div = document.getElementById('preview');
		 
		  
          if (file.files && file.files[0])
          {
              //div.innerHTML ='<img id=imghead>';
              var img = document.getElementById('imghead');
              img.onload = function(){
                //var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
                //img.width  =  rect.width;
                //img.height =  rect.height;
				//img.style.marginLeft = rect.left+'px';
                //img.style.marginTop = rect.top+'px';
				//draw(img.offsetTop,img.offsetLeft,img.offsetWidth,img.offsetHeight);
	
              }
              var reader = new FileReader();
			  //读取file完成之后加载
              reader.onload = function(evt){
				img.src = evt.target.result;
				//canvasimg();
			  }
			  //开始读取file
              reader.readAsDataURL(file.files[0]);
          }
          
        }        
		function canvasimg(e){
			var img=document.getElementById("imghead");
			var c=document.getElementById("myCanvas");
			var ctx=c.getContext("2d");
			
			if(document.getElementById("active_box") !== null) {
				var ab = document.getElementById("active_box");
				ab.style.width = e.pageX - startX + 'px';
				ab.style.height = e.pageY - startY + 'px';
				
				ctx.drawImage(img,img.offsetTop-startX,img.offsetLeft-startY,ab.style.width,ab.style.height);
			}
			   
			// 移动，更新 box 坐标
			if(document.getElementById("moving_box") !== null && dragging) {
				var mb = document.getElementById("moving_box");
				mb.style.top = e.pageY - diffY + 'px';
				mb.style.left = e.pageX - diffX + 'px';
				
				ctx.drawImage(img,img.offsetTop-mb.style.top,img.offsetLeft-mb.style.left,mb.style.width,mb.style.height);
			}
		}
		
</script>     
